<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">git
    <title>맛집을 지도에 등록하기</title>

    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=1u5gb6bmoa&submodules=geocoder"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>

    <!-- 메테리얼 불러오기 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <link rel="stylesheet" href="style.css">


</head>
<body>
    <div id="container"> <!-- 전체를 감싸는 div -->
        <div id="map_wrap">
            <h2>성수역 맛집</h2>
            <div id="map"></div> <!-- 지도 -->

            <div id="btn_wrap"><!-- 맛집검색 -->
                <input type="text" id="address">
                <button id="btn_address" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
                    주소검색하기
                </button>
            </div>
        </div>
        <!--<div id="review_wrap">
            <h2>맛집 리뷰</h2>
            <div class="demo-card-wide mdl-card mdl-shadow--2dp"> 
                <div class="mdl-card__title">
                    <h2 class="mdl-card__title-text name">맛집이름</h2>
                    <h2 class="mdl-card__title-text star">: 평점</h2>
                </div>
                <div class="mdl-card__supporting-text review">
                    리뷰 내용 작성하는 곳
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                    Get Started
                    </a>
                </div>
                <div class="mdl-card__menu">
                    <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
                    <i class="material-icons">share</i>
                    </button>
                </div>
            </div>
        </div> -->
    </div> <!-- 전체를 감싸는 div 종료 -->
    <dialog class="mdl-dialog">
        <div class="mdl-dialog__content">
            <form action="#">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <label>맛집이름</label><input id ="food_name" class="mdl-textfield__input" type="text" >
                    <label>평점</label><input id ="food_star" class="mdl-textfield__input" type="text" >
                    <label>평가내용</label><input id ="food_review" class="mdl-textfield__input" type="text" >
                    <label class="mdl-textfield__label" for="sample3">리뷰를 남겨주세요.</label>
                </div>
            </form>
        </div>
        <button id="close-btn" type="button" class="mdl-button close">Edit</button>
    </dialog>

<script>
    var storage_key = "markers";
    // marker 저장해놓을 배열
    var markerList = [];
    function loadMarkers(map){
        markerList = JSON.parse(localStorage.getItem(storage_key));
        if(!markerList) markerList = [];
        else{
            var position;
            if(markerList != null){
                for(var i in markerList){
                    var list = markerList[i];
                    var review = list['review'];
                    position = list['point'];
                    
                    // marker 설정
                    var marker = new naver.maps.Marker({
                        position: list['point'],
                        map: map
                    });
                    var contentString = [
                        '<div class="iw_inner">',
                        '   <sapn class="food_title">',
                        review['name'],
                        '</span>',
                        '   <sapn class="food_star">: ',
                        review['star'],
                        '</span>',
                        '   <p>',
                        review['review'],
                        '   </p>',
                        '</div>'
                    ].join('');
                    var infoWindow = new naver.maps.InfoWindow({
                        content: contentString
                    });
                    naver.maps.Event.addListener(marker, "click", function(e) {
                        if (infoWindow.getMap()) {
                            infoWindow.close();
                        } else {
                            infoWindow.open(map, marker);
                        }
                    });
                    infoWindow.open(map, marker);
                }
            }
            map.setCenter(new naver.maps.Point(position.x, position.y));
            }
       
    }
    function saveMarkers(marker, review){
        var save_info ={};
        save_info['point'] = marker.getPosition();
        save_info['review'] = review;
        console.log(save_info);
        markerList.push(save_info);
        console.log(markerList);
        localStorage.setItem(storage_key, JSON.stringify(markerList));
    }
    $(document).ready(function(){
        var mapOptions = {
            center: new naver.maps.LatLng(37.5487382,127.0534817),
            zoom: 14,
            scaleControl: true,
            logoControl: true,
            mapDataControl: true,
            mapTypeControl: true,
            zoomControl: true,
            zoomControlOptions: {
                position: naver.maps.Position.RIGHT_CENTER
            },
            minZoom: 1
        };
        // 지도 생성하기
        var map = new naver.maps.Map('map', mapOptions);
        // var map = new naver.maps.Map($('#map')[0], mapOptions);
        loadMarkers(map);
        $('#btn_address').click(function(e){
            new daum.Postcode({
                oncomplete: function(data) {
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분입니다.
                // 예제를 참고하여 다양한 활용법을 확인해 보세요.
                    $('#address').prop('readonly',false);
                    $('#address').val(data.address);
                    // change event 발생시키기 위해 trigger 줌
                    $('#address').prop('readonly',true).trigger('change');;
                    
                }
            }).open();
            
        });
        var dialog = document.querySelector('dialog');
        var pointer;    // marker 저장
        var mark;
        $(document).on('change', '#address', function(){
            
            naver.maps.Service.geocode({
                address: $('#address').val()
            }, function(status, response) {
                if (status !== naver.maps.Service.Status.OK) {
                    return alert('Something wrong!');
                }
                var result = response.result, // 검색 결과의 컨테이너
                    items = result.items; // 검색 결과의 배열
                // do Something
                var item = items[0];
                
                var marker = new naver.maps.Marker({
                    position: new naver.maps.Point(item.point.x, item.point.y),
                    map: map
                });
                
                pointer = marker;
               
                map.setCenter(new naver.maps.Point(item.point.x, item.point.y));
                naver.maps.Event.addListener(marker, 'click', function(e) {
                    for(var i in markerList){
                        var mark = markerList[i];
                        var review = mark['review'];
                        console.log(mark['point']);
                        console.log(marker.getPosition());
                        if(mark['point'].x == marker.getPosition().x && mark['point'].y == marker.getPosition().y){
                            console.log("검사는 됨");
                            
                            var contentString = [
                                '<div class="iw_inner">',
                                '   <sapn class="food_title">',
                                review['name'],
                                '</span>',
                                '   <sapn class="food_star">: ',
                                review['star'],
                                '</span>',
                                '   <p>',
                                review['review'],
                                '   </p>',
                                '</div>'
                            ].join('');
                            var infoWindow = new naver.maps.InfoWindow({
                                content: contentString
                            });
                            naver.maps.Event.addListener(marker, "click", function(e) {
                                if (infoWindow.getMap()) {
                                    infoWindow.close();
                                } else {
                                    infoWindow.open(map, marker);
                                }
                            });
                            infoWindow.open(map, marker);
                            return;
                        }
                    }

                    dialog.showModal();
                });
            });
        });
        dialog.querySelector('.close').addEventListener('click', function() {
            var review = {};
            review['name'] = $('#food_name').val();
            review['star'] = $('#food_star').val();
            review['review'] = $('#food_review').val();
            saveMarkers(pointer, review);
            var contentString = [
                '<div class="iw_inner">',
                '   <sapn class="food_title">',
                review['name'],
                '</span>',
                '   <sapn class="food_star">: ',
                review['star'],
                '</span>',
                '   <p>',
                review['review'],
                '   </p>',
                '</div>'
            ].join('');
            var infoWindow = new naver.maps.InfoWindow({
                content: contentString
            });
            naver.maps.Event.addListener(pointer, "click", function(e) {
                if (infoWindow.getMap()) {
                    infoWindow.close();
                } else {
                    infoWindow.open(map, pointer);
                }
            });
            infoWindow.open(map, pointer);
            dialog.close();
        });
        
    });
   
</script>
</body>
</html>